box: williamyeh/ansible:ubuntu16.04

# Build definition
build:
  # The steps that will be executed on build
  steps:
    - install-packages:
        packages: python-pip libffi-dev libssh-dev
    - script:
        name: install Python requirements
        sudo: yes
        code: |
          pip install -r tests/requirements.txt
    - script:
        name: Add this project as a role
        sudo: yes
        code: |
          mkdir -p .molecule/roles
          cd .molecule/roles/
          ln -s -r ../.. ansible-airflow
          pwd
          ls .
          ls ansible-airflow/
    - script:
        name: test installation of Airflow with this role
        sudo: yes
        code: |
          # Run the role/playbook with ansible-playbook.
          ansible-playbook -i tests/inventory tests/playbook.yml --connection=local --sudo -vvvv
          # Run the role/playbook again, checking to make sure it's idempotent.
          ansible-playbook -i tests/inventory tests/playbook.yml --connection=local --sudo \
            | grep -q 'changed=0.*failed=0' \
            && (echo 'Idempotence test: pass' && exit 0) || (echo 'Idempotence test: fail' && exit 1)
